<?php

class PredictionController extends FacebookController
{
    private $userTimezone;
    
    public function init()
    {
        parent::init();
        $this->requireLogin();

        // Handle localisation.
        // Maybe should be in parent class?
        if ($this->simulateFb) {
            $this->userTimezone = array(
                array("timezone" => 0, "locale" => "en_GB"));
//                array("timezone" => 1, "locale" => "pl_PL"));
        } else {
            $this->userTimezone = $this->facebook->api_client->users_getInfo(
                $this->fbUserId, array('timezone', 'locale'));
        }
        
    }

    public function indexAction()
    {
        $this->_forward('calendar');
    }

    /**
     * Shows a list of races for this season.
     */
    public function calendarAction()
    {
        $raceMapper = new Application_Model_RaceMapper();
        $aRaces = $raceMapper->fetchAllBySeason(date("Y"));
        $this->view->aRaces = $aRaces;
        $this->view->userId = $this->getUserId($this->fbUserId);
        $this->view->userTimezone = $this->userTimezone[0];
    }

    public function predictionAction()
    {
        $request = $this->getRequest();
        $raceId = $request->getParam("raceId");

        // Fetch the race details
        $race = new Application_Model_Race();
        $raceMapper = new Application_Model_RaceMapper();
        $raceMapper->find($raceId, $race);

        // Fetch the prediction
        $prediction = new Application_Model_Prediction();
        $predictionMapper = new Application_Model_PredictionMapper();
        $predictionMapper->fetchByRaceAndUser(
            $raceId, $this->getUserId($this->fbUserId), $prediction);

        // If it is new then set the race and user ID.
        if (!$prediction->predictionId) {
            $prediction->raceId = $raceId;
            $prediction->userId = $this->getUserId($this->fbUserId);
        }

        // We now have a prediction object with the race and user id set
        $form = new Application_Form_Prediction($prediction);

        // Disable the form if it is passed the deadline.
        if ($race->qualifyingStart->isEarlier(new Zend_Date())) {
            foreach ($form->getElements() as $element) {
                $element->disable = true;
            }
            $this->_helper->FlashMessenger(array(
                'message' => 'The deadline for predictions for this race has passed.<br />
                    You must make your predictions before the start of qualifying.',
                'level' => 'info'));
        }

        if ($request->isPost()) {

            // Submitting
            if ($form->isValid($request->getPost())) {
                $prediction = new Application_Model_Prediction($form->getValues());
                $prediction->userId = $this->getUserId($this->fbUserId);
                $mapper = new Application_Model_PredictionMapper();
                $mapper->save($prediction);

                $this->_helper->FlashMessenger(array(
                    'message' => 'Prediction saved. Good luck!',
                    'level' => 'info'));
            }
        } 

        $this->view->race = $race;
        $this->view->form = $form;
        $this->view->userTimezone = $this->userTimezone[0];
    }

    /**
     * Gets the userId from facebook ID.
     *
     * TODO: should probably be in some kind of helper class?
     *
     * @param <type> $facebookId
     * @return <type>
     */
    private function getUserId($facebookId)
    {
        $user = new Application_Model_User();
        $userMapper = new Application_Model_UserMapper();
        $userMapper->fetchByFacebookId($facebookId, $user);
        return $user->getUserId();
    }
}